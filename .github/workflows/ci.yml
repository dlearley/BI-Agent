name: CI Pipeline

on:
  push:
    branches: [main, develop, ci-github-actions-workflows-*]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8.10.0'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript type checking
        run: pnpm --filter bi-agent-analytics lint

      - name: Check for TypeScript compilation errors
        run: pnpm --filter bi-agent-analytics build

  test:
    name: Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: analytics_db_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm --filter bi-agent-analytics test
        env:
          DATABASE_URL: postgresql://postgres:test_password@localhost:5432/analytics_db_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-jwt-secret
          NODE_ENV: test

      - name: Generate coverage report
        run: pnpm --filter bi-agent-analytics test:coverage
        env:
          DATABASE_URL: postgresql://postgres:test_password@localhost:5432/analytics_db_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-jwt-secret
          NODE_ENV: test

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: analytics-service/coverage/
          retention-days: 7

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build analytics service
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: analytics-service/dist/
          retention-days: 7

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit
        run: pnpm audit --audit-level=moderate || true
        continue-on-error: true

      - name: Run npm audit (strict for production)
        run: pnpm audit --prod --audit-level=high

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./analytics-service
          file: ./analytics-service/Dockerfile
          push: false
          tags: bi-agent-analytics:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  docker-compose-smoke:
    name: Docker Compose Smoke Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file for testing
        run: |
          cd analytics-service
          cat > .env << EOF
          NODE_ENV=development
          DATABASE_URL=postgresql://postgres:password@postgres:5432/analytics_db
          REDIS_URL=redis://redis:6379
          JWT_SECRET=test-jwt-secret-for-ci
          HIPAA_MODE=true
          HIPAA_MIN_THRESHOLD=5
          ANALYTICS_CACHE_TTL=300
          ANALYTICS_REFRESH_INTERVAL=3600000
          EOF

      - name: Start services
        run: |
          cd analytics-service
          docker-compose up -d
          echo "Waiting for services to be healthy..."
          sleep 30

      - name: Check service health
        run: |
          cd analytics-service
          docker-compose ps
          
      - name: Test analytics-backend health
        run: |
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:3000/health; then
              echo "Service is healthy!"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts failed, retrying..."
            sleep 2
          done
          echo "Service failed to become healthy"
          cd analytics-service
          docker-compose logs
          exit 1

      - name: Check PostgreSQL
        run: |
          docker exec analytics-postgres pg_isready -U postgres

      - name: Check Redis
        run: |
          docker exec analytics-redis redis-cli ping

      - name: Show logs on failure
        if: failure()
        run: |
          cd analytics-service
          docker-compose logs

      - name: Stop services
        if: always()
        run: |
          cd analytics-service
          docker-compose down -v

  typed-client-check:
    name: Typed Client Generation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build analytics service
        run: pnpm build

      - name: Check TypeScript declarations
        run: |
          if [ -d "analytics-service/dist" ]; then
            echo "✅ Build artifacts generated successfully"
            if [ -f "analytics-service/dist/index.d.ts" ] || [ -f "analytics-service/dist/types/index.d.ts" ]; then
              echo "✅ TypeScript declarations found"
            else
              echo "⚠️ No TypeScript declarations found, but build succeeded"
            fi
          else
            echo "❌ Build artifacts not found"
            exit 1
          fi

      - name: Verify type safety
        run: pnpm --filter bi-agent-analytics lint

  playwright:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: analytics_db_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        run: pnpm --filter bi-agent-analytics exec playwright install --with-deps chromium

      - name: Build application
        run: pnpm build

      - name: Start application in background
        run: |
          cd analytics-service
          NODE_ENV=test \
          DATABASE_URL=postgresql://postgres:test_password@localhost:5432/analytics_db_test \
          REDIS_URL=redis://localhost:6379 \
          JWT_SECRET=test-jwt-secret \
          npm start > ../server.log 2>&1 &
          echo $! > ../server.pid

      - name: Wait for application to be ready
        run: |
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:3000/health 2>/dev/null; then
              echo "Application is ready!"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Waiting for application... ($attempt/$max_attempts)"
            sleep 2
          done
          echo "Application failed to start"
          cat server.log
          exit 1

      - name: Run Playwright tests
        run: pnpm --filter bi-agent-analytics test:e2e
        env:
          BASE_URL: http://localhost:3000
          CI: true

      - name: Stop application
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: analytics-service/playwright-report/
          retention-days: 7

      - name: Upload server logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: server-logs
          path: server.log
          retention-days: 7

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, test, build, security, docker, docker-compose-smoke, typed-client-check, playwright]
    if: always()
    steps:
      - name: Check all job statuses
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ] || \
             [ "${{ needs.docker.result }}" != "success" ] || \
             [ "${{ needs.docker-compose-smoke.result }}" != "success" ] || \
             [ "${{ needs.typed-client-check.result }}" != "success" ] || \
             [ "${{ needs.playwright.result }}" != "success" ]; then
            echo "❌ One or more checks failed"
            exit 1
          fi
          echo "✅ All checks passed!"
          echo ""
          echo "Note: DBT data quality and load tests run in separate workflows"
